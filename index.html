<!DOCTYPE html>
<html>
    <head>
        <script src="https://unpkg.com/jspsych"></script>
        <script src="https://unpkg.com/@jspsych/plugin-instructions"></script>
        <script src="https://unpkg.com/@jspsych/plugin-preload"></script>
        <script src="https://unpkg.com/@jspsych/plugin-browser-check@1.0.1"></script>
        <script src="https://unpkg.com/@jspsych/plugin-virtual-chinrest@2.0.1"></script>
        <script src="https://unpkg.com/@jspsych/plugin-instructions"></script>
  	<script src="https://unpkg.com/@jspsych/plugin-html-button-response"></script>
	<script src="jspsych-psychophysics.js"></script>
        
	<link rel="stylesheet" href="https://unpkg.com/jspsych@7.0.0/css/jspsych.css">
	    
        <style>
            html,body {
        	background-color: #808080;
        	color: white;
      		}
    	</style>
    </head>
    <body></body>

    <script>
        // Initialize jspsych
	    const jsPsych = initJsPsych({
		    on_finish: function() {
			    jsPsych.data.displayData();
		    }
	    });
        
        // placeholder variables for subject, study, and sesion ids
	    let subject_id =  Math.round(Math.random()*100); //jsPsych.data.getURLVariable('PROLIFIC_PID');
	    let study_id = 'cifar';//jsPsych.data.getURLVariable('STUDY_ID');
	    let session_id = Math.round(Math.random())+1;// jsPsych.data.getURLVariable('SESSION_ID');
        
        // add above information to dataset
	    jsPsych.data.addProperties({
		    subject_id: subject_id,
		    study_id: study_id,
            session_id: session_id
	    });
        
        // check what browser participants are using; specify minimum screen size requirements; do not allow mobile devices
	    const browser_check = {
		    type: jsPsychBrowserCheck,
		    minimum_width: 1500,
		    minimum_height: 750,
		    inclusion_function: (data) => {
			    return data.mobile === false
		    },
		    exclusion_message: (data) => {
			    if(data.mobile){
				    return '<p>Thank you for your interest in our experiment.<br>You must use a desktop/laptop computer to participate in this experiment.</p>';
			    } 
		    },
		    on_finish: function (data) {
			    data.frame_duration = (1 / data.vsync_rate) * 1000;
			    let frame_duration = (1 / data.vsync_rate) * 1000;
		    }
	    };
        
        // measure screen resolution and participants' distance from the screen; 
	    // resize stimuli accordingly in degrees of visual angle. current setting - 50 pixels are strethced to 1 dva
	    const virtual_chinrest = {
		    type: jsPsychVirtualChinrest,
		    blindspot_reps: 5,
		    resize_units: "deg",
		    pixels_per_unit: 50
	    };
        
        // welcome to experiment instructions
	    const welcome_instructions = {
		    type: jsPsychInstructions,
		    pages: [
			    '<p>Welcome to the experiment. You have volunteered to take part in a research study investigating individual differences in orienation perception.<br>'+
			    'This study consists of 2 sessions. In each session, you will complete 2 different tasks. You have to complete the two sessions within 1 week.<br>'+
			    'This means that by agreeing to take part in this experiment, you will be committing to 2 sessions.<br>'+
			    'The experimenter will invite you to complete the second session. Each session should take you around 45 minutes to complete.</p>'
		    ],
		    show_clickable_nav: true,
		    allow_backward: false
	    };
	    
	// test stimuli for condition 1
	    const mean_range1 = 50;
	    const sd_range1 = 10;
	    
	    const mean_range2 = 300;
	    const sd_range2 = 10;
	    
	    let stimuli_range_1a = [];
	    let stimuli_range_1b = [];
	    let stimuli_range_2 = [];
	   
	    
	    for (let j = 0; j < 10; j++) {
		    stimuli_range_1a[j] = Math.round(jsPsych.randomization.sampleNormal(mean_range1, sd_range1));
		    stimuli_range_1b[j] = Math.round(jsPsych.randomization.sampleNormal(mean_range1, sd_range1));		    
		    stimuli_range_2[j] = Math.round(jsPsych.randomization.sampleNormal(mean_range2, sd_range2));
	    };   
    	  
	    let full_trial = [stimuli_range_1b, stimuli_range_2, stimuli_range_1a];
	    let full_trial_str = ['range1b', 'range2', 'range1a'];
	    let stimulus_count = 0;
	    let stream_count = 0;
	    let order_of_streams = jsPsych.randomization.shuffle([0, 1, 2])
	    let stream_id = order_of_streams[stream_count];
	    
            //let stream_order_in_trial = jsPsych.randomization.sampleWithoutReplacement(block1_var, n_trials);
	// circle
	    let cirle_trial = {
		    type: jsPsychPsychophysics,
		    stimuli: [
			    {
				    obj_type: 'circle',
				    startX: 'center',
				    startY: 'center',
				    radius: () => {return full_trial[stream_id][stimulus_count]},
				    line_color: 'white',
				    line_width: 5,
				    show_start_time: 100
			    }
		    ],
		    canvas_width: 1000,
		    canvas_height: 800,
		    trial_duration: 300,
		    response_ends_trial: false,
		    background_color: '#808080',
		    on_finish: function(data) {
			    stimulus_count++;
			    if (stimulus_count>=9) {
				    stream_id = order_of_streams[stream_count];
				    data.stream_id = full_trial_str[stream_id];
				    stimulus_count = 0;
				    stream_count++;
				    console.log(stream_count);
				    console.log(stream_id);
				    console.log(full_trial[stream_id][stimulus_count]);
			    }
		    }, 
	    };
	    
	// stimulus train
	    let stimulus_stream = {
		    timeline: [cirle_trial],  //Interval1_Training, Interval2_Training,
		    repetitions: 10,
		    randomize: true,
	    };
	    
	  let stream_prompt = {
		    type: jsPsychHtmlButtonResponse,
		    stimulus: () => {return (stream_count+1).toString().concat(full_trial_str[stream_id])},
		    choices: [],
		    trial_duration: 1500,
	    };  
	    let oddity_response = {
		    type: jsPsychHtmlButtonResponse,
		    stimulus: '<p>Which stream was the odd one out?</p>',
		    choices: ['First', 'Second', 'Third'],
		    on_finish: function(data) {
			    for (let j = 0; j < 10; j++) {
				    stream_count = 0;
				    stream_id = [];
				    order_of_streams = jsPsych.randomization.shuffle([0, 1, 2])
				    stimuli_range_1a[j] = Math.round(jsPsych.randomization.sampleNormal(mean_range1, sd_range1));
				    stimuli_range_1b[j] = Math.round(jsPsych.randomization.sampleNormal(mean_range1, sd_range1));
				    stimuli_range_2[j] = Math.round(jsPsych.randomization.sampleNormal(mean_range2, sd_range2));
				    full_trial = [stimuli_range_1b, stimuli_range_2, stimuli_range_1a];
			    }; 
		    },
	    };
	    
	    let repeat_streams = {
		    timeline: [stream_prompt,stimulus_stream],  //Interval1_Training, Interval2_Training,
		    repetitions: 3,

	    };
	    jsPsych.run([
		    repeat_streams,
		    oddity_response
	    ])
    </script>
</html>
